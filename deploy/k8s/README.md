# Kubernetes Manifests

Stage 77 upgrades the Synnergy Kubernetes blueprints to production quality. The
manifests now ship with multi-document definitions that provision namespaces,
service accounts, ConfigMaps, secrets, deployments, autoscalers, disruption
budgets, services, and network policies in a single apply operation. The node
workload exposes the same runtime integration pipeline that powers the CLI by
running the Go binary with the shared configuration generated by `integration.go`
and the wallet deployment surfaces a hardened API gateway for GUI and CLI usage.

## What Is Included

- **`node.yaml`** – Creates the `synnergy` namespace, binds a dedicated service
  account, mounts the `synnergy.yaml` runtime configuration, injects encrypted
  wallet credentials, and deploys a three replica node with readiness/liveness
  probes, OpenTelemetry sidecar, anti-affinity rules, and a PodDisruptionBudget
  to guarantee quorum friendly upgrades.
- **`wallet.yaml`** – Packages the wallet API deployment, configuration, secret,
  autoscaling policy, service, and ingress network policy so that only Synnergy
  nodes can reach the encrypted wallet backend.

Both manifests default to the hardened container images produced by the Stage 77
Docker pipeline and align with the runtime integration wiring introduced in
`cmd/synnergy/main.go`. Health probes map to the CLI’s `/healthz` endpoint,
ensuring observability across CLI, API, and web interfaces.

## Prerequisites

1. Generate the operator wallet secret used by both deployments. You can reuse
   the CLI to encrypt a wallet file and export the password:
   ```bash
   synnergy wallet create --password-file wallet.pass
   kubectl create secret generic synnergy-node-wallet -n synnergy \
     --from-file=operator.json=wallet.json --from-file=password=wallet.pass
   kubectl create secret generic synnergy-wallet-secret -n synnergy \
     --from-literal=password="$(cat wallet.pass)"
   ```
2. Optionally customise the telemetry exporter in `node.yaml` to forward traces
   to your OTLP collector by editing the embedded `otel-collector.yaml`.
3. Review resource requests and tolerations to match your cluster topology.

## Deployment

Apply the manifests in order so the namespace and ConfigMaps exist before the
Deployments launch:

```bash
kubectl apply -f deploy/k8s/node.yaml
kubectl apply -f deploy/k8s/wallet.yaml
```

Within a few seconds the node Deployment will emit health snapshots that appear
in the Synnergy CLI logs thanks to the Stage 77 runtime integration loop. The
wallet Deployment auto-scales between two and five replicas based on CPU load
and only accepts traffic from the node pods, preserving privacy for regulated
workflows.

## Operational Notes

- Update the `synnergy.yaml` configuration data when adding consensus networks,
  changing gas schedules, or enabling new CLI modules; the pod will reload on
  restart without rebuilds.
- The wallets and nodes share the `synnergy-node` service account so RBAC rules
  can be managed centrally. Bind this account to a dedicated IAM role when using
  cloud managed clusters.
- NetworkPolicy ensures that only node pods can reach the wallet API. Extend
  the rule set if you introduce additional consumers such as the Next.js web
  dashboard delivered by the Stage 77 Docker compose stack.
- Use `kubectl rollout restart deployment synnergy-node -n synnergy` after
  updating container images or configuration to trigger a zero-downtime rolling
  upgrade protected by the PodDisruptionBudget.

These manifests are designed as reference implementations; tailor them to your
production cluster’s ingress, certificate management, and monitoring tooling as
required.
